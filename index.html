<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mochawesome Report</title><link rel="stylesheet" href="assets/app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:10,&quot;tests&quot;:22,&quot;passes&quot;:1,&quot;pending&quot;:0,&quot;failures&quot;:21,&quot;start&quot;:&quot;2023-11-28T14:34:59.631Z&quot;,&quot;end&quot;:&quot;2023-11-28T14:35:42.201Z&quot;,&quot;duration&quot;:42570,&quot;testsRegistered&quot;:22,&quot;passPercent&quot;:4.545454545454546,&quot;pendingPercent&quot;:0,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;b4231626-40b0-4b75-bedf-15dcc2067bfc&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;fac3678e-cdbb-46c9-97bd-d6df9c162471&quot;,&quot;title&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/cloudFunctionTemplate.test.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Cloud functions template test. Shows how to run functions against emulators\&quot;&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators \&quot;before all\&quot; hook in \&quot;Cloud functions template test. Shows how to run functions against emulators\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:230,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const serviceAccountKeyFileName = &#x27;./src/abonement-58b38-firebase-credentials.json&#x27;;\nconst projectSettings = {\n    projectId: &#x27;abonement-58b38&#x27;,\n};\ncloudFunctionText(projectSettings, serviceAccountKeyFileName);\nadmin.firestore().settings({\n    host: &#x27;localhost:8080&#x27;,\n    ssl: false,\n    keyFilename: serviceAccountKeyFileName,\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;326edbec-ff31-443c-9307-0b82e4fe7f09&quot;,&quot;parentUUID&quot;:&quot;fac3678e-cdbb-46c9-97bd-d6df9c162471&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should pass using database and the emulators&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators should pass using database and the emulators&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2260,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testValue = { value: &#x27;original&#x27; };\nawait collectionService_1.db.collection(&#x27;example&#x27;).doc(&#x27;test-doc&#x27;).set(testValue);\nconst snap = await collectionService_1.db.collection(&#x27;example&#x27;).doc(&#x27;test-doc&#x27;).get();\nconst data = snap.data();\nassert.deepEqual(data, testValue);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;b62265da-fa9a-4769-8b3e-d1f2e4bc4fa8&quot;,&quot;parentUUID&quot;:&quot;fac3678e-cdbb-46c9-97bd-d6df9c162471&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;creates a lesson and then finalizes it&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators creates a lesson and then finalizes it&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(exports.testLesson.id).set(exports.testLesson);\nassert.throws(async () =&gt; await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n    method: &#x27;POST&#x27;,\n    headers: {\n        &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n    },\n    body: exports.testLesson.id,\n}), Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(exports.testLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.done);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;714122e6-f340-43be-980d-2c32f353a761&quot;,&quot;parentUUID&quot;:&quot;fac3678e-cdbb-46c9-97bd-d6df9c162471&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;runs a cloud scheduled function&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators runs a cloud scheduled function&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2006,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const comingSoonLesson = Object.assign(Object.assign({}, exports.testLesson), { id: &#x27;new-test-lisson-id&#x27;, status: domain_1.LessonStatus.commingSoon });\nlessonScheduler_1.backendCollectionsCurrent.lessons.doc(exports.testLesson.id).set(comingSoonLesson);\nawait (0, lessonScheduler_1.lessonStartsUpdaterFunction)({\n    eventId: &#x27;test-event-id&#x27;,\n    timestamp: Date.now().toString(),\n    params: {},\n    eventType: &#x27;test-event-type&#x27;,\n    resource: {\n        service: &#x27;test-service&#x27;,\n        name: &#x27;test-name&#x27;,\n    },\n});\nconst snap = await lessonScheduler_1.backendCollectionsCurrent.lessons.doc(exports.testLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.finished);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;b580be0d-d266-4a27-a251-c6e84c6942ac&quot;,&quot;parentUUID&quot;:&quot;fac3678e-cdbb-46c9-97bd-d6df9c162471&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;b62265da-fa9a-4769-8b3e-d1f2e4bc4fa8&quot;,&quot;714122e6-f340-43be-980d-2c32f353a761&quot;,&quot;b580be0d-d266-4a27-a251-c6e84c6942ac&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6268,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;93d5c79d-9a35-402f-9d8a-b16ebae90f9a&quot;,&quot;title&quot;:&quot;lesson finalization tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonFinalization.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;1. Can finalize lesson from finished status to done status with date cheking&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 1. Can finalize lesson from finished status to done status with date cheking&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2003,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const finishedTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;finished-test-lisson-id&#x27;, status: domain_1.LessonStatus.finished, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(finishedTestLesson.id).set(finishedTestLesson);\nawait fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n    method: &#x27;POST&#x27;,\n    headers: {\n        &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n    },\n    body: finishedTestLesson.id,\n});\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(finishedTestLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.done);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;d1c5e383-aee0-4416-ad56-8ea82bee3a2e&quot;,&quot;parentUUID&quot;:&quot;93d5c79d-9a35-402f-9d8a-b16ebae90f9a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;2. Attempt to finalize lesson with date later then now will fail with error&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 2. Attempt to finalize lesson with date later then now will fail with error&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const dateInFuture = new Date();\ndateInFuture.setFullYear(dateInFuture.getFullYear() + 1);\nconst testLessonFromFuture = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;future-test-lisson-id&#x27;, status: domain_1.LessonStatus.finished, date: dateInFuture });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonFromFuture.id).set(testLessonFromFuture);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonFromFuture.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonFromFuture.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.finished);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;4b90df1d-6ec5-480a-972b-368b4cb03ebc&quot;,&quot;parentUUID&quot;:&quot;93d5c79d-9a35-402f-9d8a-b16ebae90f9a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;3. Attempt to finalize lesson from other statuses then finished will fail with error&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 3. Attempt to finalize lesson from other statuses then finished will fail with error&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const scheduledTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;scheduled-test-lisson-id&#x27;, status: domain_1.LessonStatus.scheduled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).set(scheduledTestLesson);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: scheduledTestLesson.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.scheduled);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;a229cc91-956f-4739-b8be-294d4ed3cf4e&quot;,&quot;parentUUID&quot;:&quot;93d5c79d-9a35-402f-9d8a-b16ebae90f9a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;4. Accepted user abonements will be consumed after lesson finalization&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 4. Accepted user abonements will be consumed after lesson finalization&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithAccepted = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-accepted-id&#x27;, status: domain_1.LessonStatus.finished, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;,\n    ] });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithAccepted.id).set(testLessonWithAccepted);\nconst testUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst testUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst testUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonWithAccepted.id,\n    });\n}, Error);\nconst checkTestUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst checkTestUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst checkTestUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.equal(testUser1LimitLessons, checkTestUser1LimitLessons - 1);\nassert.equal(testUser2LimitLessons, checkTestUser2LimitLessons - 1);\nassert.equal(testUser3LimitLessons, checkTestUser3LimitLessons);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;9154e41f-9a06-4223-9512-4e446af80b3d&quot;,&quot;parentUUID&quot;:&quot;93d5c79d-9a35-402f-9d8a-b16ebae90f9a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;5. When lesson is finalezed, teacher and students will get notification&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 5. When lesson is finalezed, teacher and students will get notification&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithAcceptedAndTeacher = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-accepted&amp;teacher-id&#x27;, status: domain_1.LessonStatus.finished, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0, teacherId: &#x27;test-teacher-id&#x27;, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;,\n    ] });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithAcceptedAndTeacher.id).set(testLessonWithAcceptedAndTeacher);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonWithAcceptedAndTeacher.id,\n    });\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;a9864bc5-aa69-4910-a52c-3e51d43c7494&quot;,&quot;parentUUID&quot;:&quot;93d5c79d-9a35-402f-9d8a-b16ebae90f9a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;d1c5e383-aee0-4416-ad56-8ea82bee3a2e&quot;,&quot;4b90df1d-6ec5-480a-972b-368b4cb03ebc&quot;,&quot;a229cc91-956f-4739-b8be-294d4ed3cf4e&quot;,&quot;9154e41f-9a06-4223-9512-4e446af80b3d&quot;,&quot;a9864bc5-aa69-4910-a52c-3e51d43c7494&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:10008,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;77c6aa9b-69a3-432d-8bd5-d629ad28e284&quot;,&quot;title&quot;:&quot; cancel Lesson Function tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonFinalization.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;1. Can cancel lesson from scheduled and coming soon status to canceled status&quot;,&quot;fullTitle&quot;:&quot; cancel Lesson Function tests 1. Can cancel lesson from scheduled and coming soon status to canceled status&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const scheduledTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;scheduled-test-lisson-id&#x27;, status: domain_1.LessonStatus.scheduled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nconst commingSoonTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;coming-soon-test-lisson-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).set(scheduledTestLesson);\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(commingSoonTestLesson.id).set(commingSoonTestLesson);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/cancelLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: scheduledTestLesson.id,\n    });\n}, Error);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/cancelLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: commingSoonTestLesson.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).get();\nconst scheduledTestLessonData = snap.data();\nassert.deepEqual(scheduledTestLessonData.status, domain_1.LessonStatus.canceled);\nconst snap2 = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(commingSoonTestLesson.id).get();\nconst commingSoonTestLessonData = snap2.data();\nassert.deepEqual(commingSoonTestLessonData.status, domain_1.LessonStatus.canceled);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;85884626-2936-405a-b9f1-914ffedeaeb3&quot;,&quot;parentUUID&quot;:&quot;77c6aa9b-69a3-432d-8bd5-d629ad28e284&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;2. You can not finalize canceled lesson &quot;,&quot;fullTitle&quot;:&quot; cancel Lesson Function tests 2. You can not finalize canceled lesson &quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const canceledTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;canceled-test-lisson-id&#x27;, status: domain_1.LessonStatus.canceled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(canceledTestLesson.id).set(canceledTestLesson);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: canceledTestLesson.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(canceledTestLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.canceled);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;55c4802d-2202-4b49-9ba1-bc2b1fa166e6&quot;,&quot;parentUUID&quot;:&quot;77c6aa9b-69a3-432d-8bd5-d629ad28e284&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;3. Both accepted and declained users abonements will not be consumed after lesson cancelation&quot;,&quot;fullTitle&quot;:&quot; cancel Lesson Function tests 3. Both accepted and declained users abonements will not be consumed after lesson cancelation&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2000,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithAccepted = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-accepted-id&#x27;, status: domain_1.LessonStatus.scheduled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;,\n    ] });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithAccepted.id).set(testLessonWithAccepted);\nconst testUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst testUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst testUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/cancelLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonWithAccepted.id,\n    });\n}, Error);\nconst checkTestUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst checkTestUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst checkTestUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.equal(testUser1LimitLessons, checkTestUser1LimitLessons);\nassert.equal(testUser2LimitLessons, checkTestUser2LimitLessons);\nassert.equal(testUser3LimitLessons, checkTestUser3LimitLessons);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;facf8a9c-6496-4ba2-83c1-12cf2636e00d&quot;,&quot;parentUUID&quot;:&quot;77c6aa9b-69a3-432d-8bd5-d629ad28e284&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;85884626-2936-405a-b9f1-914ffedeaeb3&quot;,&quot;55c4802d-2202-4b49-9ba1-bc2b1fa166e6&quot;,&quot;facf8a9c-6496-4ba2-83c1-12cf2636e00d&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6004,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;529495b9-dd64-4d48-8345-3284e5676b6d&quot;,&quot;title&quot;:&quot;lesson Scheduler Function tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For every rule that require us to create a new lesson within lessonCreationTimeInterval the single entity of lesson is created &quot;,&quot;fullTitle&quot;:&quot;lesson Scheduler Function tests For every rule that require us to create a new lesson within lessonCreationTimeInterval the single entity of lesson is created &quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2005,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const scheduledTestRule1 = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;scheduledTestRule1Id&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [new Date(Date.now() + lessonScheduler_1.lessonCreationTimeInterval + 100)],\n    } });\nconst scheduledTestRule2 = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;scheduledTestRule2Id&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [new Date(Date.now() - (lessonScheduler_1.lessonCreationTimeInterval - 100))],\n    } });\nconst scheduledTestRule3 = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;scheduledTestRule3Id&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [new Date(Date.now())],\n    } });\nconst testRules = [\n    scheduledTestRule1,\n    scheduledTestRule2,\n    scheduledTestRule3,\n];\nawait Promise.all(testRules.map(async (rule) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(rule.id).set(rule);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonSchedulerFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst createdLessonQuery = collectionService_1.db.collection(&#x27;test_lesson&#x27;).orderBy(&#x27;date&#x27;, &#x27;desc&#x27;).limit(1);\nconst snap = await createdLessonQuery.get();\nconst data = snap.docs[0].data();\nassert.deepEqual(data.ruleId, scheduledTestRule3.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;042334cb-c9d4-425e-b553-de2bfec5cf8b&quot;,&quot;parentUUID&quot;:&quot;529495b9-dd64-4d48-8345-3284e5676b6d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;When the lesson is scheduled the teacher notifications appear&quot;,&quot;fullTitle&quot;:&quot;lesson Scheduler Function tests When the lesson is scheduled the teacher notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;await collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(exports.testRule.id).set(exports.testRule);\nconst countNotification = await checkSendedNotifications(&#x27;testTeacherId&#x27;);\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonSchedulerFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst newCountNotification = await checkSendedNotifications(&#x27;testTeacherId&#x27;);\nassert.deepEqual(newCountNotification, countNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;eb3463db-d8b0-40ca-8749-e63b7ad2b54a&quot;,&quot;parentUUID&quot;:&quot;529495b9-dd64-4d48-8345-3284e5676b6d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;042334cb-c9d4-425e-b553-de2bfec5cf8b&quot;,&quot;eb3463db-d8b0-40ca-8749-e63b7ad2b54a&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4006,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;c8b0877f-b7c3-4793-8fb7-368dbe7e6eb0&quot;,&quot;title&quot;:&quot;lessonComingSoonUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For every lesson that is scheduled in less then lessonComingSoonTimeInterval the status changed to commingSoon&quot;,&quot;fullTitle&quot;:&quot;lessonComingSoonUpdaterFunction tests For every lesson that is scheduled in less then lessonComingSoonTimeInterval the status changed to commingSoon&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2005,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const dateInlessonComingSoonTimeInterval = new Date(Date.now() - (lessonScheduler_1.lessonComingSoonTimeInterval - 100));\nconst dateOutlessonComingSoonTimeInterval = new Date(Date.now() - (lessonScheduler_1.lessonComingSoonTimeInterval + 100));\nconst scheduledLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.scheduled, date: dateInlessonComingSoonTimeInterval });\nconst scheduledLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.scheduled, date: dateOutlessonComingSoonTimeInterval });\nconst scheduledLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.canceled, date: dateInlessonComingSoonTimeInterval });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, date: dateInlessonComingSoonTimeInterval });\nconst finishedLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.finished, date: dateInlessonComingSoonTimeInterval });\nconst inProcessLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.inProcess, date: dateInlessonComingSoonTimeInterval });\nconst testLessons = [\n    scheduledLesson1,\n    scheduledLesson2,\n    scheduledLesson3,\n    doneLesson,\n    finishedLesson,\n    inProcessLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonComingSoonUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.commingSoon);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, scheduledLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;ccd4935b-7e7c-41c3-99a9-4efe74347f5c&quot;,&quot;parentUUID&quot;:&quot;c8b0877f-b7c3-4793-8fb7-368dbe7e6eb0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;When the lesson is commingSoon the teacher and users notifications appear&quot;,&quot;fullTitle&quot;:&quot;lessonComingSoonUpdaterFunction tests When the lesson is commingSoon the teacher and users notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithTeacherId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-teacher-id&#x27;, status: domain_1.LessonStatus.scheduled, date: new Date(Date.now() - (lessonScheduler_1.lessonComingSoonTimeInterval - 100)), teacherId: &#x27;test-teacher-id&#x27; });\nconst testUsers = [\n    {\n        id: &#x27;test-user1-id&#x27;,\n        name: &#x27;test-user1-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user2-id&#x27;,\n        name: &#x27;test-user2-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user3-id&#x27;,\n        name: &#x27;test-user3-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n];\nawait Promise.all(testUsers.map(async (user) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_users&#x27;).doc(user.id).set(user);\n}));\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithTeacherId.id).set(testLessonWithTeacherId);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonComingSoonUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification + 1);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;5019f6e6-ddd4-4496-be15-d443f46b22a3&quot;,&quot;parentUUID&quot;:&quot;c8b0877f-b7c3-4793-8fb7-368dbe7e6eb0&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;ccd4935b-7e7c-41c3-99a9-4efe74347f5c&quot;,&quot;5019f6e6-ddd4-4496-be15-d443f46b22a3&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4007,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;772fca96-014d-413a-b60d-cdf9fa070924&quot;,&quot;title&quot;:&quot;lessonStartsUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For commingSoon lessons that has date less then now and not greater then date + duration the status changed to starts&quot;,&quot;fullTitle&quot;:&quot;lessonStartsUpdaterFunction tests For commingSoon lessons that has date less then now and not greater then date + duration the status changed to starts&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2005,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tooEarly = new Date(Date.now() - 100);\nconst startTime = new Date();\nconst tooLate = new Date(Date.now() + lessonScheduler_1.lessonComingSoonTimeInterval);\nconst commingSoonLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: startTime });\nconst commingSoonLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: tooEarly });\nconst commingSoonLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: tooLate });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, date: startTime });\nconst finishedLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.finished, date: startTime });\nconst scheduledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.scheduled, date: startTime });\nconst testLessons = [\n    commingSoonLesson1,\n    commingSoonLesson2,\n    commingSoonLesson3,\n    doneLesson,\n    finishedLesson,\n    scheduledLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonStartsUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.inProcess);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, commingSoonLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;ef347a7a-72ff-47f9-90bd-90241c18cf15&quot;,&quot;parentUUID&quot;:&quot;772fca96-014d-413a-b60d-cdf9fa070924&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;ef347a7a-72ff-47f9-90bd-90241c18cf15&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2005,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;03fceb42-f97e-400b-9258-ae2bf6a5cfee&quot;,&quot;title&quot;:&quot;lessonFinishedUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For started lessons that has date + duration less then now the status changed to finished&quot;,&quot;fullTitle&quot;:&quot;lessonFinishedUpdaterFunction tests For started lessons that has date + duration less then now the status changed to finished&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2003,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const inProcessStartTime = new Date(Date.now() - (oneHourDuration - 100));\nconst finishedStartTime = new Date(Date.now() - (oneHourDuration + 100));\nconst commingSoonStartTime = new Date(Date.now() - (oneHourDuration * 2));\nconst inProcessLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.inProcess, durationMin: 60, date: finishedStartTime });\nconst inProcessLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.inProcess, date: inProcessStartTime });\nconst inProcessLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.inProcess, date: commingSoonStartTime });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, date: finishedStartTime });\nconst commingSoonLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: finishedStartTime });\nconst scheduledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.scheduled, date: finishedStartTime });\nconst testLessons = [\n    inProcessLesson1,\n    inProcessLesson2,\n    inProcessLesson3,\n    doneLesson,\n    commingSoonLesson,\n    scheduledLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonFinishedUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.finished);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, inProcessLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;38ac2337-b86e-4adb-9b4a-f5eb0dda0d5e&quot;,&quot;parentUUID&quot;:&quot;03fceb42-f97e-400b-9258-ae2bf6a5cfee&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;38ac2337-b86e-4adb-9b4a-f5eb0dda0d5e&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2003,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;eb051f61-f8a3-486a-b69d-450df46d5a40&quot;,&quot;title&quot;:&quot;lessonFinalizedUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For finished lessons that has date + duration + lessonFinalizedTimeInterval less then now the status changed to finalized&quot;,&quot;fullTitle&quot;:&quot;lessonFinalizedUpdaterFunction tests For finished lessons that has date + duration + lessonFinalizedTimeInterval less then now the status changed to finalized&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tooEarlyFiniz = new Date(Date.now() - (oneHourDuration + lessonScheduler_1.lessonFinalizedTimeInterval - 100));\nconst finalizedTime = new Date(Date.now() - (oneHourDuration + lessonScheduler_1.lessonFinalizedTimeInterval + 100));\nconst sheduledTime = new Date(Date.now() + (oneHourDuration * 2));\nconst finishedLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.finished, durationMin: 60, date: finalizedTime });\nconst finishedLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.finished, date: tooEarlyFiniz });\nconst finishedLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.finished, date: sheduledTime });\nconst inProcessLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.inProcess, date: finalizedTime });\nconst commingSoonLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: finalizedTime });\nconst scheduledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.scheduled, date: finalizedTime });\nconst testLessons = [\n    finishedLesson1,\n    finishedLesson2,\n    finishedLesson3,\n    inProcessLesson,\n    commingSoonLesson,\n    scheduledLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonFinalizedUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.done);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, finishedLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;0d49ad0b-fcc1-4999-ae7e-b8cfe22b8f7f&quot;,&quot;parentUUID&quot;:&quot;eb051f61-f8a3-486a-b69d-450df46d5a40&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;When the lesson is finalized the teacher and users notifications appear&quot;,&quot;fullTitle&quot;:&quot;lessonFinalizedUpdaterFunction tests When the lesson is finalized the teacher and users notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithTeacherId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-teacher-id&#x27;, status: domain_1.LessonStatus.finished, date: new Date(Date.now() - (oneHourDuration + lessonScheduler_1.lessonFinalizedTimeInterval + 100)), teacherId: &#x27;test-teacher-id&#x27;, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;\n    ] });\nconst testUsers = [\n    {\n        id: &#x27;test-user1-id&#x27;,\n        name: &#x27;test-user1-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user2-id&#x27;,\n        name: &#x27;test-user2-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user3-id&#x27;,\n        name: &#x27;test-user3-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n];\nawait Promise.all(testUsers.map(async (user) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_users&#x27;).doc(user.id).set(user);\n}));\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithTeacherId.id).set(testLessonWithTeacherId);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonFinalizedUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;acf14132-89fa-430b-a82a-3ddc8bc1d404&quot;,&quot;parentUUID&quot;:&quot;eb051f61-f8a3-486a-b69d-450df46d5a40&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;0d49ad0b-fcc1-4999-ae7e-b8cfe22b8f7f&quot;,&quot;acf14132-89fa-430b-a82a-3ddc8bc1d404&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4004,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;c499fe00-1bfa-483e-b428-83158b834030&quot;,&quot;title&quot;:&quot;Rule change lesson updater tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;If the rule is changed scheduled lessons are changed&quot;,&quot;fullTitle&quot;:&quot;Rule change lesson updater tests If the rule is changed scheduled lessons are changed&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const lessonUpdaterTestRule = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;lessonUpdaterTestRuleId&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0],\n    } });\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterTestRule.id).set(lessonUpdaterTestRule);\nconst scheduledLessonWithTrueRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.scheduled, ruleId: &#x27;lessonUpdaterTestRuleId&#x27; });\nconst scheduledLessonWithoutRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.scheduled, ruleId: undefined });\nconst scheduledLessonWithFolseRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.scheduled, ruleId: &#x27;test-rule-id&#x27; });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, ruleId: lessonUpdaterTestRule.id });\nconst finishedLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.finished, ruleId: lessonUpdaterTestRule.id });\nconst inProcessLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.inProcess, ruleId: lessonUpdaterTestRule.id });\nconst canceledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.canceled, ruleId: lessonUpdaterTestRule.id });\nconst testLessons = [\n    scheduledLessonWithTrueRuleId,\n    scheduledLessonWithoutRuleId,\n    scheduledLessonWithFolseRuleId,\n    doneLesson,\n    finishedLesson,\n    inProcessLesson,\n    canceledLesson\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nconst newDate = new Date(cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0.getTime() + lessonScheduler_1.lessonComingSoonTimeInterval);\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterTestRule.id).update({\n    periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [newDate],\n    }\n});\nassert.throws(async () =&gt; {\n    await changeRuleLessonUpdaterFunction(lessonUpdaterTestRule.id);\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.date === newDate);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, scheduledLessonWithTrueRuleId.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;fabbfbd9-c273-4157-8676-9413bf77838d&quot;,&quot;parentUUID&quot;:&quot;c499fe00-1bfa-483e-b428-83158b834030&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;If the rule is changed teacher and users notifications appear&quot;,&quot;fullTitle&quot;:&quot;Rule change lesson updater tests If the rule is changed teacher and users notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const lessonUpdaterNotificationsTestRule = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;lessonUpdaterTestRuleId&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0],\n    } });\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterNotificationsTestRule.id).set(lessonUpdaterNotificationsTestRule);\nconst testLessonWithRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-rule-id&#x27;, status: domain_1.LessonStatus.finished, teacherId: &#x27;test-teacher-id&#x27;, ruleId: lessonUpdaterNotificationsTestRule.id, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;\n    ] });\nconst testUsers = [\n    {\n        id: &#x27;test-user1-id&#x27;,\n        name: &#x27;test-user1-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user2-id&#x27;,\n        name: &#x27;test-user2-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user3-id&#x27;,\n        name: &#x27;test-user3-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n];\nawait Promise.all(testUsers.map(async (user) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_users&#x27;).doc(user.id).set(user);\n}));\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithRuleId.id).set(testLessonWithRuleId);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nconst newDate = new Date(cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0.getTime() + lessonScheduler_1.lessonComingSoonTimeInterval);\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterNotificationsTestRule.id).update({\n    periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [newDate],\n    }\n});\nassert.throws(async () =&gt; {\n    await changeRuleLessonUpdaterFunction(lessonUpdaterNotificationsTestRule.id);\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;39038ef9-19f5-4d5d-ade4-d33ada23508f&quot;,&quot;parentUUID&quot;:&quot;c499fe00-1bfa-483e-b428-83158b834030&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;fabbfbd9-c273-4157-8676-9413bf77838d&quot;,&quot;39038ef9-19f5-4d5d-ade4-d33ada23508f&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4003,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;76effbc3-39eb-4152-a02b-82baf4fe5e59&quot;,&quot;title&quot;:&quot;Template test case. It show if the tests are able to run&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/services/serviceTest.test.ts&quot;,&quot;file&quot;:&quot;/src/services/serviceTest.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should pass&quot;,&quot;fullTitle&quot;:&quot;Template test case. It show if the tests are able to run should pass&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;assert.strictEqual(1, 1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9f632b56-d0bd-4a47-a02b-04ab7a8cfb1d&quot;,&quot;parentUUID&quot;:&quot;76effbc3-39eb-4152-a02b-82baf4fe5e59&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9f632b56-d0bd-4a47-a02b-04ab7a8cfb1d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:2000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;10.2.0&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:false,&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.3&quot;},&quot;marge&quot;:{&quot;version&quot;:&quot;6.2.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;reportDir&quot;:&quot;mochawesome-report&quot;,&quot;reportTitle&quot;:&quot;functions&quot;,&quot;reportPageTitle&quot;:&quot;Mochawesome Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;mochawesome-report/assets&quot;,&quot;jsonFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/mochawesome-report/mochawesome.json&quot;,&quot;htmlFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/mochawesome-report/mochawesome.html&quot;}"><div id="report"></div><script src="assets/app.js"></script></body></html>