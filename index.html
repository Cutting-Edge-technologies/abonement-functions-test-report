<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mochawesome Report</title><link rel="stylesheet" href="assets/app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:10,&quot;tests&quot;:22,&quot;passes&quot;:1,&quot;pending&quot;:0,&quot;failures&quot;:21,&quot;start&quot;:&quot;2023-11-27T11:12:55.329Z&quot;,&quot;end&quot;:&quot;2023-11-27T11:13:37.779Z&quot;,&quot;duration&quot;:42450,&quot;testsRegistered&quot;:22,&quot;passPercent&quot;:4.545454545454546,&quot;pendingPercent&quot;:0,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;17bc94dd-b743-4a24-8900-ddae071ddd85&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;261b7830-2eb1-4d7a-bf38-5c78e225daec&quot;,&quot;title&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/cloudFunctionTemplate.test.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Cloud functions template test. Shows how to run functions against emulators\&quot;&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators \&quot;before all\&quot; hook in \&quot;Cloud functions template test. Shows how to run functions against emulators\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:166,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const serviceAccountKeyFileName = &#x27;./src/abonement-58b38-firebase-credentials.json&#x27;;\nconst projectSettings = {\n    projectId: &#x27;abonement-58b38&#x27;,\n};\ncloudFunctionText(projectSettings, serviceAccountKeyFileName);\nadmin.firestore().settings({\n    host: &#x27;localhost:8080&#x27;,\n    ssl: false,\n    keyFilename: serviceAccountKeyFileName,\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b3a6b61c-de2d-427a-a017-a4efc48d7956&quot;,&quot;parentUUID&quot;:&quot;261b7830-2eb1-4d7a-bf38-5c78e225daec&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should pass using database and the emulators&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators should pass using database and the emulators&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2213,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testValue = { value: &#x27;original&#x27; };\nawait collectionService_1.db.collection(&#x27;example&#x27;).doc(&#x27;test-doc&#x27;).set(testValue);\nconst snap = await collectionService_1.db.collection(&#x27;example&#x27;).doc(&#x27;test-doc&#x27;).get();\nconst data = snap.data();\nassert.deepEqual(data, testValue);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;9b0b58ac-2968-4c18-a5f0-111d462fd620&quot;,&quot;parentUUID&quot;:&quot;261b7830-2eb1-4d7a-bf38-5c78e225daec&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;creates a lesson and then finalizes it&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators creates a lesson and then finalizes it&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(exports.testLesson.id).set(exports.testLesson);\nassert.throws(async () =&gt; await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n    method: &#x27;POST&#x27;,\n    headers: {\n        &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n    },\n    body: exports.testLesson.id,\n}), Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(exports.testLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.done);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;024ebb35-90d8-4e63-b5d1-dcd8596e1668&quot;,&quot;parentUUID&quot;:&quot;261b7830-2eb1-4d7a-bf38-5c78e225daec&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;runs a cloud scheduled function&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators runs a cloud scheduled function&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2004,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const comingSoonLesson = Object.assign(Object.assign({}, exports.testLesson), { id: &#x27;new-test-lisson-id&#x27;, status: domain_1.LessonStatus.commingSoon });\nlessonScheduler_1.backendCollectionsCurrent.lessons.doc(exports.testLesson.id).set(comingSoonLesson);\nawait (0, lessonScheduler_1.lessonStartsUpdaterFunction)({\n    eventId: &#x27;test-event-id&#x27;,\n    timestamp: Date.now().toString(),\n    params: {},\n    eventType: &#x27;test-event-type&#x27;,\n    resource: {\n        service: &#x27;test-service&#x27;,\n        name: &#x27;test-name&#x27;,\n    },\n});\nconst snap = await lessonScheduler_1.backendCollectionsCurrent.lessons.doc(exports.testLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.finished);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;6b348dc9-8dbc-4053-a800-f62d94d19e74&quot;,&quot;parentUUID&quot;:&quot;261b7830-2eb1-4d7a-bf38-5c78e225daec&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;9b0b58ac-2968-4c18-a5f0-111d462fd620&quot;,&quot;024ebb35-90d8-4e63-b5d1-dcd8596e1668&quot;,&quot;6b348dc9-8dbc-4053-a800-f62d94d19e74&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6218,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;9252da12-ae46-430a-89b5-6db46cfe4009&quot;,&quot;title&quot;:&quot;lesson finalization tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonFinalization.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;1. Can finalize lesson from finished status to done status with date cheking&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 1. Can finalize lesson from finished status to done status with date cheking&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const finishedTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;finished-test-lisson-id&#x27;, status: domain_1.LessonStatus.finished, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(finishedTestLesson.id).set(finishedTestLesson);\nawait fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n    method: &#x27;POST&#x27;,\n    headers: {\n        &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n    },\n    body: finishedTestLesson.id,\n});\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(finishedTestLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.done);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;f3ae67ce-f498-4c2d-a0ea-8bf787bc47ba&quot;,&quot;parentUUID&quot;:&quot;9252da12-ae46-430a-89b5-6db46cfe4009&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;2. Attempt to finalize lesson with date later then now will fail with error&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 2. Attempt to finalize lesson with date later then now will fail with error&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const dateInFuture = new Date();\ndateInFuture.setFullYear(dateInFuture.getFullYear() + 1);\nconst testLessonFromFuture = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;future-test-lisson-id&#x27;, status: domain_1.LessonStatus.finished, date: dateInFuture });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonFromFuture.id).set(testLessonFromFuture);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonFromFuture.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonFromFuture.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.finished);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;eec78390-3932-4ec8-8124-021bd5d6d31f&quot;,&quot;parentUUID&quot;:&quot;9252da12-ae46-430a-89b5-6db46cfe4009&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;3. Attempt to finalize lesson from other statuses then finished will fail with error&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 3. Attempt to finalize lesson from other statuses then finished will fail with error&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const scheduledTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;scheduled-test-lisson-id&#x27;, status: domain_1.LessonStatus.scheduled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).set(scheduledTestLesson);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: scheduledTestLesson.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.scheduled);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;b0727a63-d4d3-4a44-88d0-a66b0222b671&quot;,&quot;parentUUID&quot;:&quot;9252da12-ae46-430a-89b5-6db46cfe4009&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;4. Accepted user abonements will be consumed after lesson finalization&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 4. Accepted user abonements will be consumed after lesson finalization&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2000,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithAccepted = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-accepted-id&#x27;, status: domain_1.LessonStatus.finished, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;,\n    ] });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithAccepted.id).set(testLessonWithAccepted);\nconst testUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst testUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst testUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonWithAccepted.id,\n    });\n}, Error);\nconst checkTestUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst checkTestUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst checkTestUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.equal(testUser1LimitLessons, checkTestUser1LimitLessons - 1);\nassert.equal(testUser2LimitLessons, checkTestUser2LimitLessons - 1);\nassert.equal(testUser3LimitLessons, checkTestUser3LimitLessons);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;eb6eba27-acd0-468f-949a-4375ff174f8d&quot;,&quot;parentUUID&quot;:&quot;9252da12-ae46-430a-89b5-6db46cfe4009&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;5. When lesson is finalezed, teacher and students will get notification&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 5. When lesson is finalezed, teacher and students will get notification&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithAcceptedAndTeacher = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-accepted&amp;teacher-id&#x27;, status: domain_1.LessonStatus.finished, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0, teacherId: &#x27;test-teacher-id&#x27;, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;,\n    ] });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithAcceptedAndTeacher.id).set(testLessonWithAcceptedAndTeacher);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonWithAcceptedAndTeacher.id,\n    });\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;fea67700-12a2-42e1-ac37-f056e7840f2a&quot;,&quot;parentUUID&quot;:&quot;9252da12-ae46-430a-89b5-6db46cfe4009&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;f3ae67ce-f498-4c2d-a0ea-8bf787bc47ba&quot;,&quot;eec78390-3932-4ec8-8124-021bd5d6d31f&quot;,&quot;b0727a63-d4d3-4a44-88d0-a66b0222b671&quot;,&quot;eb6eba27-acd0-468f-949a-4375ff174f8d&quot;,&quot;fea67700-12a2-42e1-ac37-f056e7840f2a&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:10005,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;12563a6e-e2c4-46b7-8175-580ecd052fb5&quot;,&quot;title&quot;:&quot; cancel Lesson Function tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonFinalization.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;1. Can cancel lesson from scheduled and coming soon status to canceled status&quot;,&quot;fullTitle&quot;:&quot; cancel Lesson Function tests 1. Can cancel lesson from scheduled and coming soon status to canceled status&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const scheduledTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;scheduled-test-lisson-id&#x27;, status: domain_1.LessonStatus.scheduled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nconst commingSoonTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;coming-soon-test-lisson-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).set(scheduledTestLesson);\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(commingSoonTestLesson.id).set(commingSoonTestLesson);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/cancelLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: scheduledTestLesson.id,\n    });\n}, Error);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/cancelLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: commingSoonTestLesson.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).get();\nconst scheduledTestLessonData = snap.data();\nassert.deepEqual(scheduledTestLessonData.status, domain_1.LessonStatus.canceled);\nconst snap2 = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(commingSoonTestLesson.id).get();\nconst commingSoonTestLessonData = snap2.data();\nassert.deepEqual(commingSoonTestLessonData.status, domain_1.LessonStatus.canceled);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;1a69069d-7bc5-4127-9f79-ed8690e191bd&quot;,&quot;parentUUID&quot;:&quot;12563a6e-e2c4-46b7-8175-580ecd052fb5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;2. You can not finalize canceled lesson &quot;,&quot;fullTitle&quot;:&quot; cancel Lesson Function tests 2. You can not finalize canceled lesson &quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const canceledTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;canceled-test-lisson-id&#x27;, status: domain_1.LessonStatus.canceled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(canceledTestLesson.id).set(canceledTestLesson);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: canceledTestLesson.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(canceledTestLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.canceled);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;8c25979f-b148-4e9b-bc3d-153a688c8045&quot;,&quot;parentUUID&quot;:&quot;12563a6e-e2c4-46b7-8175-580ecd052fb5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;3. Both accepted and declained users abonements will not be consumed after lesson cancelation&quot;,&quot;fullTitle&quot;:&quot; cancel Lesson Function tests 3. Both accepted and declained users abonements will not be consumed after lesson cancelation&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithAccepted = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-accepted-id&#x27;, status: domain_1.LessonStatus.scheduled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;,\n    ] });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithAccepted.id).set(testLessonWithAccepted);\nconst testUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst testUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst testUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/cancelLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonWithAccepted.id,\n    });\n}, Error);\nconst checkTestUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst checkTestUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst checkTestUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.equal(testUser1LimitLessons, checkTestUser1LimitLessons);\nassert.equal(testUser2LimitLessons, checkTestUser2LimitLessons);\nassert.equal(testUser3LimitLessons, checkTestUser3LimitLessons);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;2f390afa-f88c-4b8b-8ada-027f8a50dc9f&quot;,&quot;parentUUID&quot;:&quot;12563a6e-e2c4-46b7-8175-580ecd052fb5&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;1a69069d-7bc5-4127-9f79-ed8690e191bd&quot;,&quot;8c25979f-b148-4e9b-bc3d-153a688c8045&quot;,&quot;2f390afa-f88c-4b8b-8ada-027f8a50dc9f&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6004,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;8c363334-0de4-4b4c-9f75-5dc72f89c2f6&quot;,&quot;title&quot;:&quot;lesson Scheduler Function tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For every rule that require us to create a new lesson within lessonCreationTimeInterval the single entity of lesson is created &quot;,&quot;fullTitle&quot;:&quot;lesson Scheduler Function tests For every rule that require us to create a new lesson within lessonCreationTimeInterval the single entity of lesson is created &quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2019,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const scheduledTestRule1 = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;scheduledTestRule1Id&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [new Date(Date.now() + lessonScheduler_1.lessonCreationTimeInterval + 100)],\n    } });\nconst scheduledTestRule2 = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;scheduledTestRule2Id&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [new Date(Date.now() - (lessonScheduler_1.lessonCreationTimeInterval - 100))],\n    } });\nconst scheduledTestRule3 = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;scheduledTestRule3Id&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [new Date(Date.now())],\n    } });\nconst testRules = [\n    scheduledTestRule1,\n    scheduledTestRule2,\n    scheduledTestRule3,\n];\nawait Promise.all(testRules.map(async (rule) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(rule.id).set(rule);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonSchedulerFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst createdLessonQuery = collectionService_1.db.collection(&#x27;test_lesson&#x27;).orderBy(&#x27;date&#x27;, &#x27;desc&#x27;).limit(1);\nconst snap = await createdLessonQuery.get();\nconst data = snap.docs[0].data();\nassert.deepEqual(data.ruleId, scheduledTestRule3.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;f8bb7dfa-3a7f-4b24-bc06-3b3f9d2b61b2&quot;,&quot;parentUUID&quot;:&quot;8c363334-0de4-4b4c-9f75-5dc72f89c2f6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;When the lesson is scheduled the teacher notifications appear&quot;,&quot;fullTitle&quot;:&quot;lesson Scheduler Function tests When the lesson is scheduled the teacher notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2000,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;await collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(exports.testRule.id).set(exports.testRule);\nconst countNotification = await checkSendedNotifications(&#x27;testTeacherId&#x27;);\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonSchedulerFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst newCountNotification = await checkSendedNotifications(&#x27;testTeacherId&#x27;);\nassert.deepEqual(newCountNotification, countNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;92ed0ef5-46e4-43e8-a09a-98aed9f37ce9&quot;,&quot;parentUUID&quot;:&quot;8c363334-0de4-4b4c-9f75-5dc72f89c2f6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;f8bb7dfa-3a7f-4b24-bc06-3b3f9d2b61b2&quot;,&quot;92ed0ef5-46e4-43e8-a09a-98aed9f37ce9&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4019,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;9819cd15-53c7-4f7b-b5dd-2c1a7de26448&quot;,&quot;title&quot;:&quot;lessonComingSoonUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For every lesson that is scheduled in less then lessonComingSoonTimeInterval the status changed to commingSoon&quot;,&quot;fullTitle&quot;:&quot;lessonComingSoonUpdaterFunction tests For every lesson that is scheduled in less then lessonComingSoonTimeInterval the status changed to commingSoon&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const dateInlessonComingSoonTimeInterval = new Date(Date.now() - (lessonScheduler_1.lessonComingSoonTimeInterval - 100));\nconst dateOutlessonComingSoonTimeInterval = new Date(Date.now() - (lessonScheduler_1.lessonComingSoonTimeInterval + 100));\nconst scheduledLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.scheduled, date: dateInlessonComingSoonTimeInterval });\nconst scheduledLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.scheduled, date: dateOutlessonComingSoonTimeInterval });\nconst scheduledLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.canceled, date: dateInlessonComingSoonTimeInterval });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, date: dateInlessonComingSoonTimeInterval });\nconst finishedLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.finished, date: dateInlessonComingSoonTimeInterval });\nconst inProcessLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.inProcess, date: dateInlessonComingSoonTimeInterval });\nconst testLessons = [\n    scheduledLesson1,\n    scheduledLesson2,\n    scheduledLesson3,\n    doneLesson,\n    finishedLesson,\n    inProcessLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonComingSoonUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.commingSoon);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, scheduledLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;cddaa1fc-5648-456c-8981-5b0e11136b28&quot;,&quot;parentUUID&quot;:&quot;9819cd15-53c7-4f7b-b5dd-2c1a7de26448&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;When the lesson is commingSoon the teacher and users notifications appear&quot;,&quot;fullTitle&quot;:&quot;lessonComingSoonUpdaterFunction tests When the lesson is commingSoon the teacher and users notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithTeacherId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-teacher-id&#x27;, status: domain_1.LessonStatus.scheduled, date: new Date(Date.now() - (lessonScheduler_1.lessonComingSoonTimeInterval - 100)), teacherId: &#x27;test-teacher-id&#x27; });\nconst testUsers = [\n    {\n        id: &#x27;test-user1-id&#x27;,\n        name: &#x27;test-user1-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user2-id&#x27;,\n        name: &#x27;test-user2-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user3-id&#x27;,\n        name: &#x27;test-user3-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n];\nawait Promise.all(testUsers.map(async (user) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_users&#x27;).doc(user.id).set(user);\n}));\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithTeacherId.id).set(testLessonWithTeacherId);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonComingSoonUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification + 1);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;67d3245a-da37-4d63-9295-7a05707c2c99&quot;,&quot;parentUUID&quot;:&quot;9819cd15-53c7-4f7b-b5dd-2c1a7de26448&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;cddaa1fc-5648-456c-8981-5b0e11136b28&quot;,&quot;67d3245a-da37-4d63-9295-7a05707c2c99&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4003,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;95cd9d09-4ab0-4618-b731-d3bc26af901f&quot;,&quot;title&quot;:&quot;lessonStartsUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For commingSoon lessons that has date less then now and not greater then date + duration the status changed to starts&quot;,&quot;fullTitle&quot;:&quot;lessonStartsUpdaterFunction tests For commingSoon lessons that has date less then now and not greater then date + duration the status changed to starts&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2003,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tooEarly = new Date(Date.now() - 100);\nconst startTime = new Date();\nconst tooLate = new Date(Date.now() + lessonScheduler_1.lessonComingSoonTimeInterval);\nconst commingSoonLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: startTime });\nconst commingSoonLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: tooEarly });\nconst commingSoonLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: tooLate });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, date: startTime });\nconst finishedLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.finished, date: startTime });\nconst scheduledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.scheduled, date: startTime });\nconst testLessons = [\n    commingSoonLesson1,\n    commingSoonLesson2,\n    commingSoonLesson3,\n    doneLesson,\n    finishedLesson,\n    scheduledLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonStartsUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.inProcess);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, commingSoonLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;00922d29-b10f-4d04-b448-2816370134e1&quot;,&quot;parentUUID&quot;:&quot;95cd9d09-4ab0-4618-b731-d3bc26af901f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;00922d29-b10f-4d04-b448-2816370134e1&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2003,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;e144caa5-7cd0-4922-8531-15aae700bf3b&quot;,&quot;title&quot;:&quot;lessonFinishedUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For started lessons that has date + duration less then now the status changed to finished&quot;,&quot;fullTitle&quot;:&quot;lessonFinishedUpdaterFunction tests For started lessons that has date + duration less then now the status changed to finished&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const inProcessStartTime = new Date(Date.now() - (oneHourDuration - 100));\nconst finishedStartTime = new Date(Date.now() - (oneHourDuration + 100));\nconst commingSoonStartTime = new Date(Date.now() - (oneHourDuration * 2));\nconst inProcessLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.inProcess, durationMin: 60, date: finishedStartTime });\nconst inProcessLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.inProcess, date: inProcessStartTime });\nconst inProcessLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.inProcess, date: commingSoonStartTime });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, date: finishedStartTime });\nconst commingSoonLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: finishedStartTime });\nconst scheduledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.scheduled, date: finishedStartTime });\nconst testLessons = [\n    inProcessLesson1,\n    inProcessLesson2,\n    inProcessLesson3,\n    doneLesson,\n    commingSoonLesson,\n    scheduledLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonFinishedUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.finished);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, inProcessLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;c4918bfc-e983-48d2-8428-0ea66e9a258f&quot;,&quot;parentUUID&quot;:&quot;e144caa5-7cd0-4922-8531-15aae700bf3b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;c4918bfc-e983-48d2-8428-0ea66e9a258f&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2002,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;176d70cf-e38f-4a42-8cff-2c3324686956&quot;,&quot;title&quot;:&quot;lessonFinalizedUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For finished lessons that has date + duration + lessonFinalizedTimeInterval less then now the status changed to finalized&quot;,&quot;fullTitle&quot;:&quot;lessonFinalizedUpdaterFunction tests For finished lessons that has date + duration + lessonFinalizedTimeInterval less then now the status changed to finalized&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tooEarlyFiniz = new Date(Date.now() - (oneHourDuration + lessonScheduler_1.lessonFinalizedTimeInterval - 100));\nconst finalizedTime = new Date(Date.now() - (oneHourDuration + lessonScheduler_1.lessonFinalizedTimeInterval + 100));\nconst sheduledTime = new Date(Date.now() + (oneHourDuration * 2));\nconst finishedLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.finished, durationMin: 60, date: finalizedTime });\nconst finishedLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.finished, date: tooEarlyFiniz });\nconst finishedLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.finished, date: sheduledTime });\nconst inProcessLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.inProcess, date: finalizedTime });\nconst commingSoonLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: finalizedTime });\nconst scheduledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.scheduled, date: finalizedTime });\nconst testLessons = [\n    finishedLesson1,\n    finishedLesson2,\n    finishedLesson3,\n    inProcessLesson,\n    commingSoonLesson,\n    scheduledLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonFinalizedUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.done);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, finishedLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;d8bf2513-8797-4132-9df8-830c736dc70b&quot;,&quot;parentUUID&quot;:&quot;176d70cf-e38f-4a42-8cff-2c3324686956&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;When the lesson is finalized the teacher and users notifications appear&quot;,&quot;fullTitle&quot;:&quot;lessonFinalizedUpdaterFunction tests When the lesson is finalized the teacher and users notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithTeacherId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-teacher-id&#x27;, status: domain_1.LessonStatus.finished, date: new Date(Date.now() - (oneHourDuration + lessonScheduler_1.lessonFinalizedTimeInterval + 100)), teacherId: &#x27;test-teacher-id&#x27;, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;\n    ] });\nconst testUsers = [\n    {\n        id: &#x27;test-user1-id&#x27;,\n        name: &#x27;test-user1-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user2-id&#x27;,\n        name: &#x27;test-user2-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user3-id&#x27;,\n        name: &#x27;test-user3-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n];\nawait Promise.all(testUsers.map(async (user) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_users&#x27;).doc(user.id).set(user);\n}));\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithTeacherId.id).set(testLessonWithTeacherId);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonFinalizedUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;550c1031-2c7c-40d0-879c-e5b6da1fa585&quot;,&quot;parentUUID&quot;:&quot;176d70cf-e38f-4a42-8cff-2c3324686956&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;d8bf2513-8797-4132-9df8-830c736dc70b&quot;,&quot;550c1031-2c7c-40d0-879c-e5b6da1fa585&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4003,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;a18d13ba-5df6-4135-ab87-afa06699df0b&quot;,&quot;title&quot;:&quot;Rule change lesson updater tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;If the rule is changed scheduled lessons are changed&quot;,&quot;fullTitle&quot;:&quot;Rule change lesson updater tests If the rule is changed scheduled lessons are changed&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const lessonUpdaterTestRule = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;lessonUpdaterTestRuleId&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0],\n    } });\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterTestRule.id).set(lessonUpdaterTestRule);\nconst scheduledLessonWithTrueRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.scheduled, ruleId: &#x27;lessonUpdaterTestRuleId&#x27; });\nconst scheduledLessonWithoutRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.scheduled, ruleId: undefined });\nconst scheduledLessonWithFolseRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.scheduled, ruleId: &#x27;test-rule-id&#x27; });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, ruleId: lessonUpdaterTestRule.id });\nconst finishedLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.finished, ruleId: lessonUpdaterTestRule.id });\nconst inProcessLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.inProcess, ruleId: lessonUpdaterTestRule.id });\nconst canceledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.canceled, ruleId: lessonUpdaterTestRule.id });\nconst testLessons = [\n    scheduledLessonWithTrueRuleId,\n    scheduledLessonWithoutRuleId,\n    scheduledLessonWithFolseRuleId,\n    doneLesson,\n    finishedLesson,\n    inProcessLesson,\n    canceledLesson\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nconst newDate = new Date(cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0.getTime() + lessonScheduler_1.lessonComingSoonTimeInterval);\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterTestRule.id).update({\n    periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [newDate],\n    }\n});\nassert.throws(async () =&gt; {\n    await changeRuleLessonUpdaterFunction(lessonUpdaterTestRule.id);\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.date === newDate);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, scheduledLessonWithTrueRuleId.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;8cf25d4e-8a32-4607-943d-316cb4ad8a5f&quot;,&quot;parentUUID&quot;:&quot;a18d13ba-5df6-4135-ab87-afa06699df0b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;If the rule is changed teacher and users notifications appear&quot;,&quot;fullTitle&quot;:&quot;Rule change lesson updater tests If the rule is changed teacher and users notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const lessonUpdaterNotificationsTestRule = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;lessonUpdaterTestRuleId&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0],\n    } });\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterNotificationsTestRule.id).set(lessonUpdaterNotificationsTestRule);\nconst testLessonWithRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-rule-id&#x27;, status: domain_1.LessonStatus.finished, teacherId: &#x27;test-teacher-id&#x27;, ruleId: lessonUpdaterNotificationsTestRule.id, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;\n    ] });\nconst testUsers = [\n    {\n        id: &#x27;test-user1-id&#x27;,\n        name: &#x27;test-user1-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user2-id&#x27;,\n        name: &#x27;test-user2-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user3-id&#x27;,\n        name: &#x27;test-user3-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n];\nawait Promise.all(testUsers.map(async (user) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_users&#x27;).doc(user.id).set(user);\n}));\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithRuleId.id).set(testLessonWithRuleId);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nconst newDate = new Date(cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0.getTime() + lessonScheduler_1.lessonComingSoonTimeInterval);\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterNotificationsTestRule.id).update({\n    periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [newDate],\n    }\n});\nassert.throws(async () =&gt; {\n    await changeRuleLessonUpdaterFunction(lessonUpdaterNotificationsTestRule.id);\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;c7385401-c2e0-4758-bf45-f6ba04fcbf0f&quot;,&quot;parentUUID&quot;:&quot;a18d13ba-5df6-4135-ab87-afa06699df0b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;8cf25d4e-8a32-4607-943d-316cb4ad8a5f&quot;,&quot;c7385401-c2e0-4758-bf45-f6ba04fcbf0f&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4002,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;0da0f279-5b57-4930-8e6d-fcb002689fd6&quot;,&quot;title&quot;:&quot;Template test case. It show if the tests are able to run&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/services/serviceTest.test.ts&quot;,&quot;file&quot;:&quot;/src/services/serviceTest.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should pass&quot;,&quot;fullTitle&quot;:&quot;Template test case. It show if the tests are able to run should pass&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;assert.strictEqual(1, 1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;eaa8a870-feb2-4b7c-8bac-d4493fca1fcf&quot;,&quot;parentUUID&quot;:&quot;0da0f279-5b57-4930-8e6d-fcb002689fd6&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;eaa8a870-feb2-4b7c-8bac-d4493fca1fcf&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:2000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;10.2.0&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:false,&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.3&quot;},&quot;marge&quot;:{&quot;version&quot;:&quot;6.2.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;reportDir&quot;:&quot;mochawesome-report&quot;,&quot;reportTitle&quot;:&quot;functions&quot;,&quot;reportPageTitle&quot;:&quot;Mochawesome Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;mochawesome-report/assets&quot;,&quot;jsonFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/mochawesome-report/mochawesome.json&quot;,&quot;htmlFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/mochawesome-report/mochawesome.html&quot;}"><div id="report"></div><script src="assets/app.js"></script></body></html>