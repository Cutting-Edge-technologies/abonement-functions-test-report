<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mochawesome Report</title><link rel="stylesheet" href="assets/app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:10,&quot;tests&quot;:22,&quot;passes&quot;:1,&quot;pending&quot;:0,&quot;failures&quot;:21,&quot;start&quot;:&quot;2023-11-17T14:57:17.250Z&quot;,&quot;end&quot;:&quot;2023-11-17T14:57:59.743Z&quot;,&quot;duration&quot;:42493,&quot;testsRegistered&quot;:22,&quot;passPercent&quot;:4.545454545454546,&quot;pendingPercent&quot;:0,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;fe297fbf-220f-4be7-b0b3-5862e45bf2cc&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;2e635ac8-5169-4fd3-a893-265e7c452b5c&quot;,&quot;title&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/cloudFunctionTemplate.test.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before all\&quot; hook in \&quot;Cloud functions template test. Shows how to run functions against emulators\&quot;&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators \&quot;before all\&quot; hook in \&quot;Cloud functions template test. Shows how to run functions against emulators\&quot;&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:183,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const serviceAccountKeyFileName = &#x27;./src/abonement-58b38-firebase-credentials.json&#x27;;\nconst projectSettings = {\n    projectId: &#x27;abonement-58b38&#x27;,\n};\ncloudFunctionText(projectSettings, serviceAccountKeyFileName);\nadmin.firestore().settings({\n    host: &#x27;localhost:8080&#x27;,\n    ssl: false,\n    keyFilename: serviceAccountKeyFileName,\n});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;22bcbf84-0f3e-4c37-bab3-e1cfe8fb15fd&quot;,&quot;parentUUID&quot;:&quot;2e635ac8-5169-4fd3-a893-265e7c452b5c&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should pass using database and the emulators&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators should pass using database and the emulators&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2224,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testValue = { value: &#x27;original&#x27; };\nawait collectionService_1.db.collection(&#x27;example&#x27;).doc(&#x27;test-doc&#x27;).set(testValue);\nconst snap = await collectionService_1.db.collection(&#x27;example&#x27;).doc(&#x27;test-doc&#x27;).get();\nconst data = snap.data();\nassert.deepEqual(data, testValue);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;19302081-8d2f-42b9-ae2b-411b7a5f016f&quot;,&quot;parentUUID&quot;:&quot;2e635ac8-5169-4fd3-a893-265e7c452b5c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;creates a lesson and then finalizes it&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators creates a lesson and then finalizes it&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(exports.testLesson.id).set(exports.testLesson);\nassert.throws(async () =&gt; await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n    method: &#x27;POST&#x27;,\n    headers: {\n        &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n    },\n    body: exports.testLesson.id,\n}), Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(exports.testLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.done);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;8241fdb0-1b07-4d00-8ef7-7bd144824825&quot;,&quot;parentUUID&quot;:&quot;2e635ac8-5169-4fd3-a893-265e7c452b5c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;runs a cloud scheduled function&quot;,&quot;fullTitle&quot;:&quot;Cloud functions template test. Shows how to run functions against emulators runs a cloud scheduled function&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2004,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const comingSoonLesson = Object.assign(Object.assign({}, exports.testLesson), { id: &#x27;new-test-lisson-id&#x27;, status: domain_1.LessonStatus.commingSoon });\nlessonScheduler_1.backendCollectionsCurrent.lessons.doc(exports.testLesson.id).set(comingSoonLesson);\nawait (0, lessonScheduler_1.lessonStartsUpdaterFunction)({\n    eventId: &#x27;test-event-id&#x27;,\n    timestamp: Date.now().toString(),\n    params: {},\n    eventType: &#x27;test-event-type&#x27;,\n    resource: {\n        service: &#x27;test-service&#x27;,\n        name: &#x27;test-name&#x27;,\n    },\n});\nconst snap = await lessonScheduler_1.backendCollectionsCurrent.lessons.doc(exports.testLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.finished);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/cloudFunctionTemplate.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;90a51070-6168-41d1-ae74-040e3def0476&quot;,&quot;parentUUID&quot;:&quot;2e635ac8-5169-4fd3-a893-265e7c452b5c&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;19302081-8d2f-42b9-ae2b-411b7a5f016f&quot;,&quot;8241fdb0-1b07-4d00-8ef7-7bd144824825&quot;,&quot;90a51070-6168-41d1-ae74-040e3def0476&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6229,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;090a7796-eeee-40a3-b2d4-5a48168ae3fa&quot;,&quot;title&quot;:&quot;lesson finalization tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonFinalization.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;1. Can finalize lesson from finished status to done status with date cheking&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 1. Can finalize lesson from finished status to done status with date cheking&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2004,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const finishedTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;finished-test-lisson-id&#x27;, status: domain_1.LessonStatus.finished, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(finishedTestLesson.id).set(finishedTestLesson);\nawait fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n    method: &#x27;POST&#x27;,\n    headers: {\n        &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n    },\n    body: finishedTestLesson.id,\n});\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(finishedTestLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.done);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;ff5f0f15-6ce0-4e55-962a-276f53028557&quot;,&quot;parentUUID&quot;:&quot;090a7796-eeee-40a3-b2d4-5a48168ae3fa&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;2. Attempt to finalize lesson with date later then now will fail with error&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 2. Attempt to finalize lesson with date later then now will fail with error&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const dateInFuture = new Date();\ndateInFuture.setFullYear(dateInFuture.getFullYear() + 1);\nconst testLessonFromFuture = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;future-test-lisson-id&#x27;, status: domain_1.LessonStatus.finished, date: dateInFuture });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonFromFuture.id).set(testLessonFromFuture);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonFromFuture.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonFromFuture.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.finished);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;2fef7a48-8d7e-481f-b56f-23e284940986&quot;,&quot;parentUUID&quot;:&quot;090a7796-eeee-40a3-b2d4-5a48168ae3fa&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;3. Attempt to finalize lesson from other statuses then finished will fail with error&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 3. Attempt to finalize lesson from other statuses then finished will fail with error&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const scheduledTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;scheduled-test-lisson-id&#x27;, status: domain_1.LessonStatus.scheduled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).set(scheduledTestLesson);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: scheduledTestLesson.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.scheduled);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;7886da5f-9b29-4b2c-acea-cd607220f207&quot;,&quot;parentUUID&quot;:&quot;090a7796-eeee-40a3-b2d4-5a48168ae3fa&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;4. Accepted user abonements will be consumed after lesson finalization&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 4. Accepted user abonements will be consumed after lesson finalization&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithAccepted = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-accepted-id&#x27;, status: domain_1.LessonStatus.finished, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;,\n    ] });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithAccepted.id).set(testLessonWithAccepted);\nconst testUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst testUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst testUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonWithAccepted.id,\n    });\n}, Error);\nconst checkTestUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst checkTestUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst checkTestUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.equal(testUser1LimitLessons, checkTestUser1LimitLessons - 1);\nassert.equal(testUser2LimitLessons, checkTestUser2LimitLessons - 1);\nassert.equal(testUser3LimitLessons, checkTestUser3LimitLessons);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;db8c2dc9-a568-4d97-bc72-1c09a16def1f&quot;,&quot;parentUUID&quot;:&quot;090a7796-eeee-40a3-b2d4-5a48168ae3fa&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;5. When lesson is finalezed, teacher and students will get notification&quot;,&quot;fullTitle&quot;:&quot;lesson finalization tests 5. When lesson is finalezed, teacher and students will get notification&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithAcceptedAndTeacher = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-accepted&amp;teacher-id&#x27;, status: domain_1.LessonStatus.finished, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0, teacherId: &#x27;test-teacher-id&#x27;, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;,\n    ] });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithAcceptedAndTeacher.id).set(testLessonWithAcceptedAndTeacher);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonWithAcceptedAndTeacher.id,\n    });\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;d8332ef7-60b3-4a5e-a526-ebb9df66d3c6&quot;,&quot;parentUUID&quot;:&quot;090a7796-eeee-40a3-b2d4-5a48168ae3fa&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;ff5f0f15-6ce0-4e55-962a-276f53028557&quot;,&quot;2fef7a48-8d7e-481f-b56f-23e284940986&quot;,&quot;7886da5f-9b29-4b2c-acea-cd607220f207&quot;,&quot;db8c2dc9-a568-4d97-bc72-1c09a16def1f&quot;,&quot;d8332ef7-60b3-4a5e-a526-ebb9df66d3c6&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:10008,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;74f24d96-cb8f-4d1b-9c35-4c3bd7c1c17f&quot;,&quot;title&quot;:&quot; cancel Lesson Function tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonFinalization.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;1. Can cancel lesson from scheduled and coming soon status to canceled status&quot;,&quot;fullTitle&quot;:&quot; cancel Lesson Function tests 1. Can cancel lesson from scheduled and coming soon status to canceled status&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const scheduledTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;scheduled-test-lisson-id&#x27;, status: domain_1.LessonStatus.scheduled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nconst commingSoonTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;coming-soon-test-lisson-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).set(scheduledTestLesson);\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(commingSoonTestLesson.id).set(commingSoonTestLesson);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/cancelLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: scheduledTestLesson.id,\n    });\n}, Error);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/cancelLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: commingSoonTestLesson.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(scheduledTestLesson.id).get();\nconst scheduledTestLessonData = snap.data();\nassert.deepEqual(scheduledTestLessonData.status, domain_1.LessonStatus.canceled);\nconst snap2 = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(commingSoonTestLesson.id).get();\nconst commingSoonTestLessonData = snap2.data();\nassert.deepEqual(commingSoonTestLessonData.status, domain_1.LessonStatus.canceled);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;d6e461a9-8de2-45b2-81ce-a1eea0b79266&quot;,&quot;parentUUID&quot;:&quot;74f24d96-cb8f-4d1b-9c35-4c3bd7c1c17f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;2. You can not finalize canceled lesson &quot;,&quot;fullTitle&quot;:&quot; cancel Lesson Function tests 2. You can not finalize canceled lesson &quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const canceledTestLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;canceled-test-lisson-id&#x27;, status: domain_1.LessonStatus.canceled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0 });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(canceledTestLesson.id).set(canceledTestLesson);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/finalizeLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: canceledTestLesson.id,\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(canceledTestLesson.id).get();\nconst data = snap.data();\nassert.deepEqual(data.status, domain_1.LessonStatus.canceled);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;d798fbab-7877-42d5-8d8b-4ac684a58da5&quot;,&quot;parentUUID&quot;:&quot;74f24d96-cb8f-4d1b-9c35-4c3bd7c1c17f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;3. Both accepted and declained users abonements will not be consumed after lesson cancelation&quot;,&quot;fullTitle&quot;:&quot; cancel Lesson Function tests 3. Both accepted and declained users abonements will not be consumed after lesson cancelation&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithAccepted = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-accepted-id&#x27;, status: domain_1.LessonStatus.scheduled, date: cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;,\n    ] });\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithAccepted.id).set(testLessonWithAccepted);\nconst testUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst testUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst testUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.throws(async () =&gt; {\n    await fetch.default(&#x27;http://127.0.0.1:5001/abonement-58b38/us-central1/cancelLesson&#x27;, {\n        method: &#x27;POST&#x27;,\n        headers: {\n            &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;,\n        },\n        body: testLessonWithAccepted.id,\n    });\n}, Error);\nconst checkTestUser1LimitLessons = await chekAbonementLimitFunction(&#x27;test-user1-id&#x27;);\nconst checkTestUser2LimitLessons = await chekAbonementLimitFunction(&#x27;test-user2-id&#x27;);\nconst checkTestUser3LimitLessons = await chekAbonementLimitFunction(&#x27;test-user3-id&#x27;);\nassert.equal(testUser1LimitLessons, checkTestUser1LimitLessons);\nassert.equal(testUser2LimitLessons, checkTestUser2LimitLessons);\nassert.equal(testUser3LimitLessons, checkTestUser3LimitLessons);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonFinalization.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;afa66575-47f6-4688-be0f-3b467fc2a540&quot;,&quot;parentUUID&quot;:&quot;74f24d96-cb8f-4d1b-9c35-4c3bd7c1c17f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;d6e461a9-8de2-45b2-81ce-a1eea0b79266&quot;,&quot;d798fbab-7877-42d5-8d8b-4ac684a58da5&quot;,&quot;afa66575-47f6-4688-be0f-3b467fc2a540&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6004,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;ee1a9c34-842e-4867-9c1d-1c2ba14ea78f&quot;,&quot;title&quot;:&quot;lesson Scheduler Function tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For every rule that require us to create a new lesson within lessonCreationTimeInterval the single entity of lesson is created &quot;,&quot;fullTitle&quot;:&quot;lesson Scheduler Function tests For every rule that require us to create a new lesson within lessonCreationTimeInterval the single entity of lesson is created &quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2020,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const scheduledTestRule1 = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;scheduledTestRule1Id&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [new Date(Date.now() + lessonScheduler_1.lessonCreationTimeInterval + 100)],\n    } });\nconst scheduledTestRule2 = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;scheduledTestRule2Id&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [new Date(Date.now() - (lessonScheduler_1.lessonCreationTimeInterval - 100))],\n    } });\nconst scheduledTestRule3 = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;scheduledTestRule3Id&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [new Date(Date.now())],\n    } });\nconst testRules = [\n    scheduledTestRule1,\n    scheduledTestRule2,\n    scheduledTestRule3,\n];\nawait Promise.all(testRules.map(async (rule) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(rule.id).set(rule);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonSchedulerFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst createdLessonQuery = collectionService_1.db.collection(&#x27;test_lesson&#x27;).orderBy(&#x27;date&#x27;, &#x27;desc&#x27;).limit(1);\nconst snap = await createdLessonQuery.get();\nconst data = snap.docs[0].data();\nassert.deepEqual(data.ruleId, scheduledTestRule3.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;02fffaf2-124b-4a23-9db5-972c24aab10f&quot;,&quot;parentUUID&quot;:&quot;ee1a9c34-842e-4867-9c1d-1c2ba14ea78f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;When the lesson is scheduled the teacher notifications appear&quot;,&quot;fullTitle&quot;:&quot;lesson Scheduler Function tests When the lesson is scheduled the teacher notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;await collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(exports.testRule.id).set(exports.testRule);\nconst countNotification = await checkSendedNotifications(&#x27;testTeacherId&#x27;);\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonSchedulerFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst newCountNotification = await checkSendedNotifications(&#x27;testTeacherId&#x27;);\nassert.deepEqual(newCountNotification, countNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;575f9ade-4b44-4be4-93eb-b9c5d32e8882&quot;,&quot;parentUUID&quot;:&quot;ee1a9c34-842e-4867-9c1d-1c2ba14ea78f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;02fffaf2-124b-4a23-9db5-972c24aab10f&quot;,&quot;575f9ade-4b44-4be4-93eb-b9c5d32e8882&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4021,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;d9317060-c8e8-43d5-963c-c7dd5ecead8a&quot;,&quot;title&quot;:&quot;lessonComingSoonUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For every lesson that is scheduled in less then lessonComingSoonTimeInterval the status changed to commingSoon&quot;,&quot;fullTitle&quot;:&quot;lessonComingSoonUpdaterFunction tests For every lesson that is scheduled in less then lessonComingSoonTimeInterval the status changed to commingSoon&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2003,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const dateInlessonComingSoonTimeInterval = new Date(Date.now() - (lessonScheduler_1.lessonComingSoonTimeInterval - 100));\nconst dateOutlessonComingSoonTimeInterval = new Date(Date.now() - (lessonScheduler_1.lessonComingSoonTimeInterval + 100));\nconst scheduledLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.scheduled, date: dateInlessonComingSoonTimeInterval });\nconst scheduledLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.scheduled, date: dateOutlessonComingSoonTimeInterval });\nconst scheduledLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.canceled, date: dateInlessonComingSoonTimeInterval });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, date: dateInlessonComingSoonTimeInterval });\nconst finishedLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.finished, date: dateInlessonComingSoonTimeInterval });\nconst inProcessLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.inProcess, date: dateInlessonComingSoonTimeInterval });\nconst testLessons = [\n    scheduledLesson1,\n    scheduledLesson2,\n    scheduledLesson3,\n    doneLesson,\n    finishedLesson,\n    inProcessLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonComingSoonUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.commingSoon);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, scheduledLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;cff42aff-d810-42bf-bab0-5a677838fbc4&quot;,&quot;parentUUID&quot;:&quot;d9317060-c8e8-43d5-963c-c7dd5ecead8a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;When the lesson is commingSoon the teacher and users notifications appear&quot;,&quot;fullTitle&quot;:&quot;lessonComingSoonUpdaterFunction tests When the lesson is commingSoon the teacher and users notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithTeacherId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-teacher-id&#x27;, status: domain_1.LessonStatus.scheduled, date: new Date(Date.now() - (lessonScheduler_1.lessonComingSoonTimeInterval - 100)), teacherId: &#x27;test-teacher-id&#x27; });\nconst testUsers = [\n    {\n        id: &#x27;test-user1-id&#x27;,\n        name: &#x27;test-user1-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user2-id&#x27;,\n        name: &#x27;test-user2-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user3-id&#x27;,\n        name: &#x27;test-user3-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n];\nawait Promise.all(testUsers.map(async (user) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_users&#x27;).doc(user.id).set(user);\n}));\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithTeacherId.id).set(testLessonWithTeacherId);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonComingSoonUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification + 1);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;24fe61a8-326d-4106-9e79-9d6b9215161b&quot;,&quot;parentUUID&quot;:&quot;d9317060-c8e8-43d5-963c-c7dd5ecead8a&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;cff42aff-d810-42bf-bab0-5a677838fbc4&quot;,&quot;24fe61a8-326d-4106-9e79-9d6b9215161b&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4005,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;40faf521-46ac-4418-99b0-42e1da958749&quot;,&quot;title&quot;:&quot;lessonStartsUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For commingSoon lessons that has date less then now and not greater then date + duration the status changed to starts&quot;,&quot;fullTitle&quot;:&quot;lessonStartsUpdaterFunction tests For commingSoon lessons that has date less then now and not greater then date + duration the status changed to starts&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2006,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tooEarly = new Date(Date.now() - 100);\nconst startTime = new Date();\nconst tooLate = new Date(Date.now() + lessonScheduler_1.lessonComingSoonTimeInterval);\nconst commingSoonLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: startTime });\nconst commingSoonLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: tooEarly });\nconst commingSoonLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: tooLate });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, date: startTime });\nconst finishedLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.finished, date: startTime });\nconst scheduledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.scheduled, date: startTime });\nconst testLessons = [\n    commingSoonLesson1,\n    commingSoonLesson2,\n    commingSoonLesson3,\n    doneLesson,\n    finishedLesson,\n    scheduledLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonStartsUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.inProcess);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, commingSoonLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;7ab18a81-2aa0-4710-9214-e64fa45e871d&quot;,&quot;parentUUID&quot;:&quot;40faf521-46ac-4418-99b0-42e1da958749&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;7ab18a81-2aa0-4710-9214-e64fa45e871d&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2006,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;900f687d-f2af-4b36-b98e-ed13bba99005&quot;,&quot;title&quot;:&quot;lessonFinishedUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For started lessons that has date + duration less then now the status changed to finished&quot;,&quot;fullTitle&quot;:&quot;lessonFinishedUpdaterFunction tests For started lessons that has date + duration less then now the status changed to finished&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2004,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const inProcessStartTime = new Date(Date.now() - (oneHourDuration - 100));\nconst finishedStartTime = new Date(Date.now() - (oneHourDuration + 100));\nconst commingSoonStartTime = new Date(Date.now() - (oneHourDuration * 2));\nconst inProcessLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.inProcess, durationMin: 60, date: finishedStartTime });\nconst inProcessLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.inProcess, date: inProcessStartTime });\nconst inProcessLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.inProcess, date: commingSoonStartTime });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, date: finishedStartTime });\nconst commingSoonLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: finishedStartTime });\nconst scheduledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.scheduled, date: finishedStartTime });\nconst testLessons = [\n    inProcessLesson1,\n    inProcessLesson2,\n    inProcessLesson3,\n    doneLesson,\n    commingSoonLesson,\n    scheduledLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonFinishedUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.finished);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, inProcessLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;2debf027-9ab9-438a-b7c3-6c7db104b5b7&quot;,&quot;parentUUID&quot;:&quot;900f687d-f2af-4b36-b98e-ed13bba99005&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;2debf027-9ab9-438a-b7c3-6c7db104b5b7&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2004,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;9bba96ce-7eee-4af5-ac7a-b3860f6f2209&quot;,&quot;title&quot;:&quot;lessonFinalizedUpdaterFunction tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;For finished lessons that has date + duration + lessonFinalizedTimeInterval less then now the status changed to finalized&quot;,&quot;fullTitle&quot;:&quot;lessonFinalizedUpdaterFunction tests For finished lessons that has date + duration + lessonFinalizedTimeInterval less then now the status changed to finalized&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2003,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const tooEarlyFiniz = new Date(Date.now() - (oneHourDuration + lessonScheduler_1.lessonFinalizedTimeInterval - 100));\nconst finalizedTime = new Date(Date.now() - (oneHourDuration + lessonScheduler_1.lessonFinalizedTimeInterval + 100));\nconst sheduledTime = new Date(Date.now() + (oneHourDuration * 2));\nconst finishedLesson1 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.finished, durationMin: 60, date: finalizedTime });\nconst finishedLesson2 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.finished, date: tooEarlyFiniz });\nconst finishedLesson3 = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.finished, date: sheduledTime });\nconst inProcessLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.inProcess, date: finalizedTime });\nconst commingSoonLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.commingSoon, date: finalizedTime });\nconst scheduledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.scheduled, date: finalizedTime });\nconst testLessons = [\n    finishedLesson1,\n    finishedLesson2,\n    finishedLesson3,\n    inProcessLesson,\n    commingSoonLesson,\n    scheduledLesson,\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonFinalizedUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.status === domain_1.LessonStatus.done);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, finishedLesson1.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;76c7f719-2523-4ccc-a18e-f7b8ba93476c&quot;,&quot;parentUUID&quot;:&quot;9bba96ce-7eee-4af5-ac7a-b3860f6f2209&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;When the lesson is finalized the teacher and users notifications appear&quot;,&quot;fullTitle&quot;:&quot;lessonFinalizedUpdaterFunction tests When the lesson is finalized the teacher and users notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2002,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const testLessonWithTeacherId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-teacher-id&#x27;, status: domain_1.LessonStatus.finished, date: new Date(Date.now() - (oneHourDuration + lessonScheduler_1.lessonFinalizedTimeInterval + 100)), teacherId: &#x27;test-teacher-id&#x27;, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;\n    ] });\nconst testUsers = [\n    {\n        id: &#x27;test-user1-id&#x27;,\n        name: &#x27;test-user1-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user2-id&#x27;,\n        name: &#x27;test-user2-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user3-id&#x27;,\n        name: &#x27;test-user3-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n];\nawait Promise.all(testUsers.map(async (user) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_users&#x27;).doc(user.id).set(user);\n}));\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithTeacherId.id).set(testLessonWithTeacherId);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.throws(async () =&gt; {\n    await (0, lessonScheduler_1.lessonFinalizedUpdaterFunction)({\n        eventId: &#x27;test-event-id&#x27;,\n        timestamp: Date.now().toString(),\n        params: {},\n        eventType: &#x27;test-event-type&#x27;,\n        resource: {\n            service: &#x27;test-service&#x27;,\n            name: &#x27;test-name&#x27;,\n        },\n    });\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;5dbff9f3-3e6a-4419-906e-6ef035479a72&quot;,&quot;parentUUID&quot;:&quot;9bba96ce-7eee-4af5-ac7a-b3860f6f2209&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;76c7f719-2523-4ccc-a18e-f7b8ba93476c&quot;,&quot;5dbff9f3-3e6a-4419-906e-6ef035479a72&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4005,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;56d80b61-ae94-4f2a-8b50-5e1c173fcc87&quot;,&quot;title&quot;:&quot;Rule change lesson updater tests&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts&quot;,&quot;file&quot;:&quot;/src/functions/lessonScheduler.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;If the rule is changed scheduled lessons are changed&quot;,&quot;fullTitle&quot;:&quot;Rule change lesson updater tests If the rule is changed scheduled lessons are changed&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const lessonUpdaterTestRule = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;lessonUpdaterTestRuleId&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0],\n    } });\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterTestRule.id).set(lessonUpdaterTestRule);\nconst scheduledLessonWithTrueRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson1-id&#x27;, status: domain_1.LessonStatus.scheduled, ruleId: &#x27;lessonUpdaterTestRuleId&#x27; });\nconst scheduledLessonWithoutRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson2-id&#x27;, status: domain_1.LessonStatus.scheduled, ruleId: undefined });\nconst scheduledLessonWithFolseRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson3-id&#x27;, status: domain_1.LessonStatus.scheduled, ruleId: &#x27;test-rule-id&#x27; });\nconst doneLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson4-id&#x27;, status: domain_1.LessonStatus.done, ruleId: lessonUpdaterTestRule.id });\nconst finishedLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson5-id&#x27;, status: domain_1.LessonStatus.finished, ruleId: lessonUpdaterTestRule.id });\nconst inProcessLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.inProcess, ruleId: lessonUpdaterTestRule.id });\nconst canceledLesson = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson6-id&#x27;, status: domain_1.LessonStatus.canceled, ruleId: lessonUpdaterTestRule.id });\nconst testLessons = [\n    scheduledLessonWithTrueRuleId,\n    scheduledLessonWithoutRuleId,\n    scheduledLessonWithFolseRuleId,\n    doneLesson,\n    finishedLesson,\n    inProcessLesson,\n    canceledLesson\n];\nawait Promise.all(testLessons.map(async (lesson) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(lesson.id).set(lesson);\n}));\nconst newDate = new Date(cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0.getTime() + lessonScheduler_1.lessonComingSoonTimeInterval);\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterTestRule.id).update({\n    periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [newDate],\n    }\n});\nassert.throws(async () =&gt; {\n    await changeRuleLessonUpdaterFunction(lessonUpdaterTestRule.id);\n}, Error);\nconst snap = await collectionService_1.db.collection(&#x27;test_lessons&#x27;).get();\nconst data = snap.docs.map((doc) =&gt; doc.data());\nconst checkLesson = data.filter((lesson) =&gt; lesson.date === newDate);\nassert.deepEqual(checkLesson.length, 1);\nassert.equal(checkLesson[0].id, scheduledLessonWithTrueRuleId.id);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;000ade49-cc29-4d9b-9052-d315ca1e4c15&quot;,&quot;parentUUID&quot;:&quot;56d80b61-ae94-4f2a-8b50-5e1c173fcc87&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;If the rule is changed teacher and users notifications appear&quot;,&quot;fullTitle&quot;:&quot;Rule change lesson updater tests If the rule is changed teacher and users notifications appear&quot;,&quot;timedOut&quot;:true,&quot;duration&quot;:2001,&quot;state&quot;:&quot;failed&quot;,&quot;pass&quot;:false,&quot;fail&quot;:true,&quot;pending&quot;:false,&quot;code&quot;:&quot;const lessonUpdaterNotificationsTestRule = Object.assign(Object.assign({}, exports.testRule), { id: &#x27;lessonUpdaterTestRuleId&#x27;, periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0],\n    } });\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterNotificationsTestRule.id).set(lessonUpdaterNotificationsTestRule);\nconst testLessonWithRuleId = Object.assign(Object.assign({}, cloudFunctionTemplate_test_1.testLesson), { id: &#x27;test-lisson-with-rule-id&#x27;, status: domain_1.LessonStatus.finished, teacherId: &#x27;test-teacher-id&#x27;, ruleId: lessonUpdaterNotificationsTestRule.id, accepted: [\n        &#x27;test-user1-id&#x27;,\n        &#x27;test-user2-id&#x27;,\n    ], declained: [\n        &#x27;test-user3-id&#x27;\n    ] });\nconst testUsers = [\n    {\n        id: &#x27;test-user1-id&#x27;,\n        name: &#x27;test-user1-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user2-id&#x27;,\n        name: &#x27;test-user2-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n    {\n        id: &#x27;test-user3-id&#x27;,\n        name: &#x27;test-user3-name&#x27;,\n        avatar: &#x27;&#x27;,\n    },\n];\nawait Promise.all(testUsers.map(async (user) =&gt; {\n    await collectionService_1.db.collection(&#x27;test_users&#x27;).doc(user.id).set(user);\n}));\nawait collectionService_1.db.collection(&#x27;test_lessons&#x27;).doc(testLessonWithRuleId.id).set(testLessonWithRuleId);\nconst testUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst testUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst testUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst testTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nconst newDate = new Date(cloudFunctionTemplate_test_1.mochDate2023_7_14_15_30_0.getTime() + lessonScheduler_1.lessonComingSoonTimeInterval);\nawait collectionService_1.db.collection(&#x27;test_rules&#x27;).doc(lessonUpdaterNotificationsTestRule.id).update({\n    periodicity: {\n        periodicityType: domain_1.PeriodicityType.manualDate,\n        periodicityRule: [newDate],\n    }\n});\nassert.throws(async () =&gt; {\n    await changeRuleLessonUpdaterFunction(lessonUpdaterNotificationsTestRule.id);\n}, Error);\nconst checkTestUser1Notification = await checkSendedNotifications(&#x27;test-user1-id&#x27;);\nconst checkTestUser2Notification = await checkSendedNotifications(&#x27;test-user2-id&#x27;);\nconst checkTestUser3Notification = await checkSendedNotifications(&#x27;test-user3-id&#x27;);\nconst checkTestTeacherNotification = await checkSendedNotifications(&#x27;test-teacher-id&#x27;);\nassert.equal(testUser1Notification, checkTestUser1Notification + 1);\nassert.equal(testUser2Notification, checkTestUser2Notification + 1);\nassert.equal(testUser3Notification, checkTestUser3Notification);\nassert.equal(testTeacherNotification, checkTestTeacherNotification + 1);&quot;,&quot;err&quot;:{&quot;message&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)&quot;,&quot;estack&quot;:&quot;Error: Timeout of 2000ms exceeded. For async tests and hooks, ensure \&quot;done()\&quot; is called; if returning a Promise, ensure it resolves. (/home/runner/work/abonement/abonement/functions/src/functions/lessonScheduler.test.ts)\n    at listOnTimeout (node:internal/timers:559:17)\n    at processTimers (node:internal/timers:502:7)&quot;},&quot;uuid&quot;:&quot;dbe53aec-a35c-4527-8ef8-559eecf1dbd7&quot;,&quot;parentUUID&quot;:&quot;56d80b61-ae94-4f2a-8b50-5e1c173fcc87&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[],&quot;failures&quot;:[&quot;000ade49-cc29-4d9b-9052-d315ca1e4c15&quot;,&quot;dbe53aec-a35c-4527-8ef8-559eecf1dbd7&quot;],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4002,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000},{&quot;uuid&quot;:&quot;64933787-de85-4c75-98cb-6d1379f870e8&quot;,&quot;title&quot;:&quot;Template test case. It show if the tests are able to run&quot;,&quot;fullFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/src/services/serviceTest.test.ts&quot;,&quot;file&quot;:&quot;/src/services/serviceTest.test.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;should pass&quot;,&quot;fullTitle&quot;:&quot;Template test case. It show if the tests are able to run should pass&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;assert.strictEqual(1, 1);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5e58f5f2-7412-427e-9e3b-00c4c29520a4&quot;,&quot;parentUUID&quot;:&quot;64933787-de85-4c75-98cb-6d1379f870e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;5e58f5f2-7412-427e-9e3b-00c4c29520a4&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:2000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:2000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;10.2.0&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:false,&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.3&quot;},&quot;marge&quot;:{&quot;version&quot;:&quot;6.2.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;reportDir&quot;:&quot;mochawesome-report&quot;,&quot;reportTitle&quot;:&quot;functions&quot;,&quot;reportPageTitle&quot;:&quot;Mochawesome Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;mochawesome-report/assets&quot;,&quot;jsonFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/mochawesome-report/mochawesome.json&quot;,&quot;htmlFile&quot;:&quot;/home/runner/work/abonement/abonement/functions/mochawesome-report/mochawesome.html&quot;}"><div id="report"></div><script src="assets/app.js"></script></body></html>